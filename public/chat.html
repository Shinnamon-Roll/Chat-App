<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="style.css" />
  <title>Chat Room</title>
</head>
<body class="chat-page">
  <!-- Header -->
  <header class="app-header">
    <h1><a href="/" class="home-link">Chat app</a></h1>
  </header>

  <!-- Layout: chat (left) + member (right) -->
  <main class="chat-layout">
    <!-- Left: chat area -->
    <section class="chat-main">
      <div class="chat-room-bar">
        <div class="room-name" id="roomName">Room</div>
      </div>

      <div id="messages" class="messages"></div>

      <form id="composer" class="composer" autocomplete="off">
        <input id="messageInput" type="text" placeholder="Type here" />
        <button id="sendBtn" type="submit">Send</button>
        <button id="exitBtn" type="button" class="secondary">Exit</button>
      </form>
    </section>

    <!-- Right: members -->
    <aside class="member-panel">
      <div class="member-bar">Member</div>
      <ul id="memberList" class="member-list"></ul>
    </aside>
  </main>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    /* ------------------ params / state ------------------ */
    const params   = new URLSearchParams(location.search);
    const roomId   = params.get('room');
    const userName = localStorage.getItem('userName') || params.get('name') || 'guest';
    const userId   = localStorage.getItem('userId') || null;

    if (!roomId) location.replace('/');

    document.getElementById('roomName').textContent = roomId;
    document.title = `Chat Room - ${roomId}`;

    const socket       = io();
    const messagesEl   = document.getElementById('messages');
    const memberListEl = document.getElementById('memberList');
    const formEl       = document.getElementById('composer');
    const inputEl      = document.getElementById('messageInput');

    /* ------------------ helpers ------------------ */
    const esc = (s) => String(s).replace(/[&<>"']/g, m => (
      {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]
    ));
    const addRow = (node) => {
      messagesEl.appendChild(node);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    };

    function addMessageDOM({ side='left', timestamp='', sender='', message='', system=false, kind='' }){
      const wrap = document.createElement('div');
      wrap.className = `msg ${system ? 'system' : side}`;

      if (system) {
        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.innerHTML = `<span class="ts">${esc(timestamp)}</span> <b>[SYSTEM]</b> ${esc(message)}`;
        wrap.appendChild(meta);
        return addRow(wrap);
      }

      // meta row
      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.innerHTML = `<span class="ts">${esc(timestamp)}</span> <span class="who">${esc(sender)}</span>`;
      wrap.appendChild(meta);

      // bubble
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.textContent = message;       // respects newlines/spaces
      if (kind === 'whisper') bubble.classList.add('whisper');

      wrap.appendChild(bubble);
      addRow(wrap);
    }

    /* ------------------ socket lifecycle ------------------ */
    socket.on('connect', () => {
      socket.emit('joinRoom', { userId, userName, roomId });
    });

    /* ------------------ events from server ------------------ */
    socket.on('history', ({ history }) => {
      history.forEach(h => {
        if (h.kind === 'system') {
          addMessageDOM({ system:true, timestamp:h.timestamp, message:h.text });
        } else if (h.kind === 'emote') {
          addMessageDOM({ system:true, timestamp:h.timestamp, message:h.text });
        } else if (h.kind === 'whisper') {
          const side = (h.fromName === userName) ? 'right' : 'left';
          addMessageDOM({ side, timestamp:h.timestamp, sender:`${h.fromName} (whisper)`, message:h.text, kind:'whisper' });
        } else {
          const side = (h.fromName === userName) ? 'right' : 'left';
          addMessageDOM({ side, timestamp:h.timestamp, sender:h.fromName, message:h.text });
        }
      });
    });

    socket.on('systemMessage', ({ text, timestamp }) => {
      addMessageDOM({ system:true, timestamp, message:text });
    });

    socket.on('receiveMessage', ({ userName: sender, message, timestamp }) => {
      const side = sender === userName ? 'right' : 'left';
      addMessageDOM({ side, timestamp, sender, message });
    });

    socket.on('emoteMessage', ({ text, timestamp }) => {
      addMessageDOM({ system:true, timestamp, message:text });
    });

    socket.on('whisper', ({ fromName, toName, message, timestamp }) => {
      const side = (fromName === userName) ? 'right' : 'left';
      addMessageDOM({ side, timestamp, sender:`${fromName} (whisper)`, message, kind:'whisper' });
    });

    socket.on('roomUsers', ({ users }) => {
      memberListEl.innerHTML = users.map(u => `<li>${esc(u)}</li>`).join('');
    });

    socket.on('nickOk', ({ newName }) => {
      localStorage.setItem('userName', newName);
    });

    socket.on('nickError', ({ message }) => {
      addMessageDOM({ system:true, timestamp:new Date().toLocaleString(), message });
    });

    /* ------------------ send / commands ------------------ */
    formEl.addEventListener('submit', (e) => {
      e.preventDefault();
      const raw = inputEl.value;
      const msg = raw.trim();
      if (!msg) return;

      if (msg.startsWith('/')) {
        const parts = msg.split(' ');
        if ((parts[0] === '/w' || parts[0] === '/whisper') && parts[1]) {
          localStorage.setItem('lastWhisperTo', parts[1]);
        }
        socket.emit('clientCommand', { roomId, input: msg });
      } else {
        socket.emit('sendMessage', { userName, roomId, message: raw });
      }

      inputEl.value = '';
      inputEl.focus();
    });

    /* ------------------ exit ------------------ */
    document.getElementById('exitBtn').addEventListener('click', () => {
      socket.emit('leaveRoom');
      const group = roomId.startsWith('boy') ? 'boy' : 'girl';
      location.href = `/selectRoom?name=${encodeURIComponent(localStorage.getItem('userName') || userName)}&group=${group}`;
    });

    window.addEventListener('beforeunload', () => socket.emit('leaveRoom'));
  </script>
</body>
</html>
